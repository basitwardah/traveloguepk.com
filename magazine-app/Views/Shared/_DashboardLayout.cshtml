@using System.Security.Claims
@inject Microsoft.AspNetCore.Identity.UserManager<Entities.Models.ApplicationUser> UserManager

@{
    var user = await UserManager.GetUserAsync(User);
    var userRoles = User.Claims.Where(c => c.Type == ClaimTypes.Role).Select(c => c.Value).ToList();
    var isAdmin = userRoles.Contains("Admin") || userRoles.Contains("SuperAdmin");
    var isEmployee = userRoles.Contains("Uploader");
    var isCustomer = userRoles.Contains("Customer");
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Travelogue PK Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0C789A',
                        'primary-orange': '#FF6B35',
                        'dark-navy': '#1A2332'
                    }
                }
            }
        }
        
        // Suppress Tailwind CDN warning
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0]?.includes?.('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar Overlay (Mobile Only) -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden" onclick="toggleSidebar()"></div>
        
        <!-- Sidebar -->
        <aside id="dashboard-sidebar" class="fixed lg:static inset-y-0 left-0 w-64 bg-dark-navy text-white flex-shrink-0 overflow-y-auto z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out sidebar-visible">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center">
                        <i class="fas fa-mountain text-primary-orange text-3xl mr-3"></i>
                        <div>
                            <h2 class="text-xl font-bold">Travelogue PK</h2>
                            <p class="text-xs text-gray-400">Dashboard</p>
                        </div>
                    </div>
                    <!-- Close Button (Mobile Only) -->
                    <button id="sidebar-close-btn" class="lg:hidden text-white hover:text-primary-orange transition-colors p-2" onclick="toggleSidebar()">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- User Profile Card -->
                <div class="bg-white/10 rounded-lg p-4 mb-6">
                    <div class="flex items-center mb-2">
                        <div class="w-10 h-10 bg-primary-orange rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-sm">@(user?.FullName ?? "User")</p>
                            <p class="text-xs text-gray-400">@user?.Email</p>
                        </div>
                    </div>
                    
                    @* Only show subscription information for Customer role *@
                    @if (isCustomer)
                    {
                        @if (user?.HasActiveSubscription ?? false)
                        {
                            <div class="mt-2 bg-green-500/20 text-green-300 px-2 py-1 rounded text-xs flex items-center">
                                <i class="fas fa-crown mr-1"></i>
                                <span>@user.SubscriptionPlan Subscriber</span>
                            </div>
                        }
                        else
                        {
                            <div class="mt-2 bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded text-xs flex items-center">
                                <i class="fas fa-user mr-1"></i>
                                <span>Free Account</span>
                            </div>
                        }
                    }
                    @* Employee roles (SuperAdmin, Admin, Uploader) don't see subscription info *@
                </div>

                <nav>
                    @if (isAdmin)
                    {
                        <!-- Admin Navigation -->
                        <div class="mb-6">
                            <p class="text-xs text-gray-400 uppercase tracking-wider mb-2 px-2">Admin Panel</p>
                            
                            <a asp-controller="AdminDashboard" asp-action="Index" class="nav-item @(ViewContext.RouteData.Values["controller"]?.ToString() == "AdminDashboard" && ViewContext.RouteData.Values["action"]?.ToString() == "Index" ? "active" : "")">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard Overview</span>
                            </a>
                            
                            <a asp-controller="AdminDashboard" asp-action="Users" class="nav-item @(ViewContext.RouteData.Values["controller"]?.ToString() == "AdminDashboard" && ViewContext.RouteData.Values["action"]?.ToString() == "Users" ? "active" : "")">
                                <i class="fas fa-users"></i>
                                <span>Manage Users</span>
                            </a>
                            
                            <a asp-controller="AdminDashboard" asp-action="CreateEmployee" class="nav-item @(ViewContext.RouteData.Values["action"]?.ToString() == "CreateEmployee" ? "active" : "")">
                                <i class="fas fa-user-plus"></i>
                                <span>Create Employee</span>
                            </a>
                            
                            <a asp-controller="GuideAdmin" asp-action="Index" class="nav-item @(ViewContext.RouteData.Values["controller"]?.ToString() == "GuideAdmin" ? "active" : "")">
                                <i class="fas fa-book"></i>
                                <span>Manage Magazines</span>
                            </a>
                        </div>
                    }
                    
                    @if (isEmployee && !isAdmin)
                    {
                        <!-- Employee Navigation -->
                        <div class="mb-6">
                            <p class="text-xs text-gray-400 uppercase tracking-wider mb-2 px-2">Employee Panel</p>
                            
                            <a asp-controller="GuideAdmin" asp-action="Index" class="nav-item @(ViewContext.RouteData.Values["controller"]?.ToString() == "GuideAdmin" ? "active" : "")">
                                <i class="fas fa-book"></i>
                                <span>Manage Magazines</span>
                            </a>
                            
                            <a asp-controller="GuideAdmin" asp-action="Create" class="nav-item">
                                <i class="fas fa-plus-circle"></i>
                                <span>Upload Magazine</span>
                            </a>
                        </div>
                    }
                    
                    @* Only Customer role sees customer navigation and upgrade option *@
                    @if (isCustomer && !isAdmin && !isEmployee)
                    {
                        <!-- Customer Navigation -->
                        <div class="mb-6">
                            <p class="text-xs text-gray-400 uppercase tracking-wider mb-2 px-2">My Dashboard</p>
                            
                            <a asp-controller="UserDashboard" asp-action="Index" class="nav-item @(ViewContext.RouteData.Values["controller"]?.ToString() == "UserDashboard" && ViewContext.RouteData.Values["action"]?.ToString() == "Index" ? "active" : "")">
                                <i class="fas fa-home"></i>
                                <span>Dashboard</span>
                            </a>
                            
                            <a asp-controller="UserDashboard" asp-action="Favorites" class="nav-item @(ViewContext.RouteData.Values["action"]?.ToString() == "Favorites" ? "active" : "")">
                                <i class="fas fa-heart"></i>
                                <span>My Favorites</span>
                            </a>
                            
                            @* Only show upgrade option for customers without subscription *@
                            @if (!user?.HasActiveSubscription ?? false)
                            {
                                <a href="#" class="nav-item bg-primary-orange/10 border border-primary-orange">
                                    <i class="fas fa-crown"></i>
                                    <span>Upgrade to Premium</span>
                                </a>
                            }
                        </div>
                    }
                    
                    <!-- Common Navigation -->
                    <div class="border-t border-gray-700 pt-4">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-2 px-2">Browse</p>
                        
                        <a asp-controller="Guide" asp-action="Index" class="nav-item">
                            <i class="fas fa-th-large"></i>
                            <span>All Magazines</span>
                        </a>
                        
                        <a asp-controller="Categories" asp-action="Index" class="nav-item">
                            <i class="fas fa-layer-group"></i>
                            <span>Categories</span>
                        </a>
                        
                        <a asp-controller="Home" asp-action="Index" class="nav-item">
                            <i class="fas fa-globe"></i>
                            <span>Visit Website</span>
                        </a>
                    </div>
                    
                    <!-- Logout -->
                    <div class="border-t border-gray-700 mt-4 pt-4">
                        <form asp-controller="Account" asp-action="Logout" method="post">
                            <button type="submit" class="nav-item w-full text-left text-red-400 hover:bg-red-500/10">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                        </form>
                    </div>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <div id="main-content-wrapper" class="flex-1 flex flex-col overflow-hidden lg:transition-all lg:duration-300">
            
            <!-- Top Header -->
            <header class="bg-white shadow-sm z-10">
                <div class="px-4 sm:px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <!-- Hamburger Menu Button (Mobile & Desktop Toggle) -->
                        <button id="sidebar-toggle-btn" class="text-gray-700 hover:text-primary-orange transition-colors p-2 rounded-lg hover:bg-gray-100" onclick="toggleSidebar()" aria-label="Toggle Sidebar">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <div>
                            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">@ViewData["Title"]</h1>
                            @if (ViewData["Subtitle"] != null)
                            {
                                <p class="text-sm text-gray-600">@ViewData["Subtitle"]</p>
                            }
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 sm:gap-4">
                        @if (TempData["Success"] != null)
                        {
                            <div class="bg-green-100 text-green-800 px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span class="hidden sm:inline">@TempData["Success"]</span>
                                <span class="sm:hidden">Success</span>
                            </div>
                        }
                        @if (TempData["Error"] != null)
                        {
                            <div class="bg-red-100 text-red-800 px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span class="hidden sm:inline">@TempData["Error"]</span>
                                <span class="sm:hidden">Error</span>
                            </div>
                        }
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                @RenderBody()
            </main>
        </div>
    </div>

    <style>
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s;
            margin-bottom: 0.25rem;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item.active {
            background-color: #FF6B35;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item i {
            width: 1.25rem;
            text-align: center;
        }
        
        /* Sidebar Responsive Styles */
        @@media (max-width: 1023px) {
            #dashboard-sidebar {
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }
            
            /* On mobile, sidebar starts hidden */
            #dashboard-sidebar {
                transform: translateX(-100%);
            }
            
            /* Show sidebar when visible class is added */
            #dashboard-sidebar.sidebar-visible {
                transform: translateX(0);
            }
        }
        
        @@media (min-width: 1024px) {
            /* Desktop: sidebar visible by default when sidebar-visible class is present */
            #dashboard-sidebar.sidebar-visible {
                transform: translateX(0);
            }
            
            /* Hide sidebar when sidebar-visible class is removed */
            #dashboard-sidebar:not(.sidebar-visible) {
                transform: translateX(-100%);
                position: fixed;
            }
            
            /* Adjust main content when sidebar is hidden on desktop */
            #main-content-wrapper.sidebar-hidden {
                margin-left: 0;
            }
            
            #main-content-wrapper {
                transition: margin-left 0.3s ease-in-out;
            }
            
            #sidebar-close-btn {
                display: none !important;
            }
            
            #sidebar-overlay {
                display: none !important;
            }
        }
    </style>

    <script>
        // Toggle Sidebar Function
        function toggleSidebar() {
            const sidebar = document.getElementById('dashboard-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mainContent = document.getElementById('main-content-wrapper');
            const isMobile = window.innerWidth < 1024;
            
            if (!sidebar) return;
            
            const isVisible = sidebar.classList.contains('sidebar-visible');
            
            if (isMobile) {
                // Mobile behavior
                if (isVisible) {
                    // Hide sidebar on mobile
                    sidebar.classList.remove('sidebar-visible');
                    sidebar.classList.add('-translate-x-full');
                    if (overlay) overlay.classList.add('hidden');
                    document.body.style.overflow = '';
                } else {
                    // Show sidebar on mobile
                    sidebar.classList.add('sidebar-visible');
                    sidebar.classList.remove('-translate-x-full');
                    if (overlay) overlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent body scroll when sidebar is open
                }
            } else {
                // Desktop behavior
                if (isVisible) {
                    // Hide sidebar on desktop
                    sidebar.classList.remove('sidebar-visible');
                    if (mainContent) mainContent.classList.add('sidebar-hidden');
                } else {
                    // Show sidebar on desktop
                    sidebar.classList.add('sidebar-visible');
                    if (mainContent) mainContent.classList.remove('sidebar-hidden');
                }
            }
        }
        
        // Initialize sidebar state
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('dashboard-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mainContent = document.getElementById('main-content-wrapper');
            const isMobile = window.innerWidth < 1024;
            
            if (sidebar) {
                if (isMobile) {
                    // Mobile: start hidden
                    sidebar.classList.remove('sidebar-visible');
                    sidebar.classList.add('-translate-x-full');
                } else {
                    // Desktop: start visible
                    sidebar.classList.add('sidebar-visible');
                }
            }
            
            // Close sidebar when clicking overlay (mobile only)
            if (overlay) {
                overlay.addEventListener('click', function() {
                    if (window.innerWidth < 1024) {
                        toggleSidebar();
                    }
                });
            }
            
            // Handle window resize
            window.addEventListener('resize', function() {
                const isMobileNow = window.innerWidth < 1024;
                const sidebar = document.getElementById('dashboard-sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const mainContent = document.getElementById('main-content-wrapper');
                
                if (!sidebar) return;
                
                if (isMobileNow) {
                    // Switched to mobile: hide sidebar if visible
                    sidebar.classList.remove('sidebar-visible');
                    sidebar.classList.add('-translate-x-full');
                    if (overlay) overlay.classList.add('hidden');
                    document.body.style.overflow = '';
                    if (mainContent) mainContent.classList.remove('sidebar-hidden');
                } else {
                    // Switched to desktop: show sidebar if it was visible
                    if (sidebar.classList.contains('sidebar-visible')) {
                        sidebar.classList.remove('-translate-x-full');
                    }
                    if (overlay) overlay.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
        });
        
        // Keyboard support - ESC to close sidebar
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const sidebar = document.getElementById('dashboard-sidebar');
                if (sidebar && sidebar.classList.contains('sidebar-visible')) {
                    if (window.innerWidth < 1024 || sidebar.classList.contains('sidebar-visible')) {
                        toggleSidebar();
                    }
                }
            }
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>

